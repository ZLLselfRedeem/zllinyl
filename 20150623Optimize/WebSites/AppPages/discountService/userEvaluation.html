<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <meta name="format-detection" content="telephone=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="renderer" content="webkit" />
    <meta http-equiv="pragma" content="no-cache" />
    <meta http-equiv="Cache-Control" content="no-cache, must-revalidate" />
    <meta http-equiv="expires" content="Wed, 26 Feb 1997 08:21:57 GMT" />
    <title>用户评价</title>
    <link href="style.css" rel="stylesheet" />
    <link href="../../tron/bootstrap/css/font-awesome.min.css" rel="stylesheet" />
    <script src="../../tron/coms/jquery/jquery-2.1.1/jquery-2.1.1.min.js"></script>
    <script src="../../tron/coms/jquery-plugins/jquery.cookie/jquery.cookie.js"></script>
    <script src="../../series/plugins/mustache/mustache.min.js"></script>
    <script src="../../series/date.js"></script>
  </head>
  <body>
    <div class="wrap userEvaluation" id="actwrap"></div>
    <script type="text/Mustache" id="list">
      {{#list}}
      <ul>
        <li class="time">{{time}}</li>
        <li>
           <ul>
             {{#list}}
             <li class="goCon" data-type="discomment" data-value="{{preOrder19dianId}}" data-values="{{orderId}}">{{customName}}({{mobilePhoneNumber}})<span class="evaluat{{evaluationValue}}">{{con}}<i class="fa fa-angle-right"></i></span></li>
             {{/list}}
           </ul>
        </li>
      </ul>
      {{/list}}
      <div id="tip" style="text-align: center; padding: 8px 0;">上拉加载更多</div>
    </script>
  </body>
</html>
<script type="text/javascript">
  var qs = {}, page = 1, tree = {}, doing = false, ismore=true;
  
  /*function chkLevel(type){
    if( type === -1 ){
      return 2
    }else if( type === 0 ){
      return 1
    }else if( type === 1 ){
      return 0
    }
  }*/
  
  function chkDate(data){
    var y = 0; var m = 0; var d = 0;
    for ( var i = 0; i < data.evaluationList.length; i++ ){
      var time = data.evaluationList[i].evaluationTime;
      var dd = time.split('-');
      y = dd[0];
      m = dd[1];
      d = dd[2];
      if ( !tree[y] ){
        tree[y] = {}
      }
      if ( !tree[y][m] ){
        tree[y][m] = {}
      }
      if ( !tree[y][m][d] ){
        tree[y][m][d] = [];
      }
      tree[y][m][d].push(data.evaluationList[i]);
    }
  }
  
  function s(){
    var dist = [];
    for( var y in tree ){
      for( var m in tree[y] ){
        for( var d in tree[y][m] ){
          time = y + "-" + m + "-" + d;
          var _data = tree[y][m][d];
          
          _data = _data.map(function(dd){
            if(dd.evaluationValue == -1){
              dd.evaluationValue = 2
              dd.con = '差评'
            }else if(dd.evaluationValue == 0){
              dd.con = '中评'
            }else if(dd.evaluationValue == 1){
              dd.con = '好评'
            }
            return dd;
          });

          dist.push({ time: time, list: _data });
        }
      }
    }
		dist = dist.sort(function(a, b){
			var _a = new Date(a.time).getTime();
			var _b = new Date(b.time).getTime();
			return _b - _a;
		});
    return dist;
  }
  
  function resize(){
    var t = $(document).scrollTop();
    $(window).on('scroll', function(){
      if(t>0){
        var wh = $(window).height();
        var sh = $('body').scrollTop();
        if ( wh + sh + 50 >= $('body').outerHeight() && !doing && ismore ){
          page++;
          getData();
        }
      }
      t = $(document).scrollTop();
    });
  }
  
  $(document).ready(function(){
    
    var s = window.location.search ? window.location.search.substr(1) : (window.location.href.split('?') > 1 ? window.location.href.split('?')[1] : '');
        s = s.split('&');
        for ( var i = 0 ; i < s.length ; i++ ){
          var d = s[i].split('=');
          qs[d[0]] = d[1];
          $("[name='" + d[0] + "']").val(d[1]);
        }
        
        getData(resize);
  });
  
  function getData(callback){
    $("#tip").html("正在加载...");
    if( doing ){ return }
      var data = {'shopId': qs.s, 'pageSize': 15, 'pageIndex': page}
      doing = true;
      $.post('/AppPages/Shop/ShopHandler.ashx?action=query_evaluation_list', data, function(data){
        $("#tip").html("上拉加载更多");
        ismore = data.msg.isMore;
        if(data.error === 0){
          var datas = [];
          
          for ( var i = 0 ; i < data.msg.evaluationList.length ; i++ ){
            var msg = data.msg.evaluationList[i];
            
            msg.evaluationTime = new Date(msg.evaluationTime * 1000).format('yyyy-MM-dd');
            datas.push(msg);
          }
          chkDate(data.msg);
          $('#actwrap').html(Mustache.render($('#list').html(), { list: s() }));
          
          if(data.msg.evaluationList.length == 0){
            var str = '<ul><li style="width:100%; text-align:center;">暂无评论^_^</li></ul>';
            $('#actwrap').html(str);
          }
          
          typeof(callback)==='function' && callback();
        }else{
          showMask(data.msg)
        }
        if(!ismore){ $("#tip").html(""); }
        
       $('.goCon').on('click', function(){
          var type = $(this).attr('data-type'),
          value = $(this).attr('data-value'),
          values = $(this).attr('data-values');
          
          // 暂时不做
          if ( inAp ){
            window.location = "message:type:"+type+",value:"+value+",value1:"+values;
          }
          else if ( inAn ){
            window.redEnvelopeShare.getRecomandTopicsValue('{ "type": "' + type + '", "value": "' + value + '", "value1": "' + values + '" }');
          }
        });
        
        doing = false;
      }, 'json');
   }
   function getDevices() {
    var u = navigator.userAgent, app = navigator.appVersion;
    return {
      trident: u.indexOf('Trident') > -1,
      presto: u.indexOf('Presto') > -1,
      webKit: u.indexOf('AppleWebKit') > -1,
      gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1,
      mobile: !!u.match(/AppleWebKit.*Mobile.*/),
      iOS: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),
      Android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1,
      iPhone: u.indexOf('iPhone') > -1,
      iPad: u.indexOf('iPad') > -1,
      webApp: u.indexOf('Safari') == -1
    };
  };
    
    var device = getDevices();
    
    var inWx = navigator.userAgent.match(/MicroMessenger/i); // wei xin
    var inAp = device.iOS; // ios
    var inAn = device.Android; // android
     
  
</script>
