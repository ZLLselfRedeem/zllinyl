<!DOCTYPE html>
<html style="background: #fffee3;">
	<head>
	    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
	    <meta name="format-detection" content="telephone=no" />
	    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
	    <meta name="renderer" content="webkit" />
	    <meta http-equiv="pragma" content="no-cache" />
	    <meta http-equiv="Cache-Control" content="no-cache, must-revalidate" />
	    <meta http-equiv="expires" content="Wed, 26 Feb 1997 08:21:57 GMT" />
	    <title>悠先点菜</title>
	    <link href="style.css" rel="stylesheet" />
	    <script src="js/series.js"></script>
	    <script src="../../tron/coms/jquery/jquery-2.1.1/jquery-2.1.1.min.js"></script>
	    <script src="../../tron/coms/jquery-plugins/jquery.cookie/jquery.cookie.js"></script>
	</head>
	<body style="background: #fffee3;" onbeforeunload="window.checkLeave()">
		
		<div id="getted">
			<div class="top" id="gettedContent">
				<img class="bg" src="img/bg.jpg" />
				<span class="hide desc">
					<%if (status === 3){%>
						这是你已领取的<%=shopName%><p id="discountPrice"><%=couponName%>元</p>抵扣券~
					<%}else{%>
					恭喜！您已成功领取<%=shopName%><p id="discountPrice"><%=couponName%>元</p>抵扣券~
					<%};%></span>
				<span class="hide number"><p id="confirmPhoneNumber"></p><p id="correct">号码纠错</p></span>
				<img id="downloadBtn" src="img/downBtn.png" />
				<span class="instr">下载后用手机号码登录，即可使用</span>
			</div>
			<div class="bottom gettedBottom">
				<img class="txt1" src="img/txt1.png" />
				<ul class="hide foodDiscountList" id="foodDiscountList">
					<% _.each(dishList, function(list){ %>
					<li>
						<img src="<%=list.dishImage%>" />
						<span id="foodName"><%=list.dishName%></span>
						<span class="price"><span id="oldPrice"><del>￥<%=list.originalPrice%></del></span><span id="nowPrice">￥<%=list.nowPrice%></span></span>
					</li>
					<% }); %>
				</ul>
			</div>
		</div>
		
		<div id="correctBg"></div>
	    <div id="correctDiv">
	    	<p class="currTitle">号码纠错</p>
	    	<p class="currDesc">手别抖，只能修改一次哦~</p>
	    	<input type="tel" id="newPhoneNumber" />
	    	<div class="correctBtn" id="cancel">取消</div>
	    	<div class="correctBtn" id="confirm">确定</div>
	    </div>
	</body>
	<script type="text/javascript">
		var OJS = new ojs();
		var req = window.location.href.split('?');
		if ( req.length === 2 ){
			req = _.fromQuery(req[1])
		}else{
			req = {};
		};
		
		req.phoneNumber = $.cookie('mobile') || '';
		
		$(document).ready(function(){
        	$.ajax({
	            contentType: "application/json",
	            url: '/coupon/CouponMsg.aspx/GetCouponDetail',
	            type: 'POST',
	            dataType: 'json',
	            data: JSON.stringify({"couponId":req.couponId, "preOrder19DianIdEncrypt": req.id, "phoneNumber": req.phoneNumber}),
	            success: function(msg) {
	                msg = JSON.parse(msg.d);
	                console.log(msg);
	                
	                msg.status = req.status ? Number(req.status) : 0;
	                
	                //是否已领抵扣券
	                //if(msg.isGot){
	                	
	                	$('#confirmPhoneNumber').html(req.phoneNumber);
		                if(msg.IsCorrected){
		                	$('#correct').css({"display":"none"});
		                }else{
		                	$('#correct').css({"display":"inline-block"});
		                }
						document.getElementById('gettedContent').innerHTML = OJS.render('gettedContent', msg);
						
						document.getElementById('foodDiscountList').innerHTML = OJS.render('foodDiscountList', msg)
						
						$("#gettedContent span").removeClass("hide");
						$("#foodDiscountList").removeClass("hide");
						
						$("#downloadBtn").on("click", function(){
							window.location = "http://a.app.qq.com/o/simple.jsp?pkgname=va.dish.sys";
						});
						
						$("#correct").on("click", function(){
							$("#newPhoneNumber").val(req.phoneNumber)
							$('#correctBg').fadeIn({"display":"block"});
							$('#correctDiv').fadeIn({"display":"block"});
						});
						
						$("#cancel").on("click", function(){
							$('#correctBg').fadeOut({"display":"none"});
							$('#correctDiv').fadeOut({"display":"none"});
						});
						
						var couponGetDetailId = msg.couponGetDetailId;
						
						$("#confirm").on("click", function(){
							var phoneNum = $('#newPhoneNumber').val();
							if( phoneNum == "请输入手机号码"){
								alert("请输入手机号码");
							}else{
								if( isPhoneNumber(phoneNum) ){
									$.ajax({
							            contentType: "application/json",
							            url: '/Coupon/CouponMsg.aspx/CorrectNumber',
							            type: 'POST',
							            dataType: 'json',
							            data: JSON.stringify({"couponGetDetailId":couponGetDetailId, "phoneNumber": phoneNum}),
							            success: function(msg) {
							            	msg = JSON.parse(msg.d);
							            	if(msg.correctState === 0){
							            		alert("修改失败，请重新修改");
												
							            	}else if(msg.correctState === 1){
							            		alert("修改成功！");
												$('#correctBg').fadeOut({"display":"none"});
												$('#correctDiv').fadeOut({"display":"none"});
												$("#confirmPhoneNumber").html(phoneNum);
		                						$('#correct').css({"display":"none"});
		                						$.cookie('mobile_' + req.id, phoneNum, {
							                		expires: new Date('3015/01/01 00:00:00')
							                	});
							            	}else if(msg.correctState === 2){
							            		alert("你输入的号码已领过该券");
							            	}
							            },
							            error: function(e) {
							                window.doing = false;
							                console.log('服务端出错');
							            }
						        	});
								}else{
									alert('您输入的手机号码不正确！');
								}
							}
						});
	                //}else{
	                	//window.location.href = "index.html?couponId=2&preOrder19DianId=70&phoneNumber=";
	                //}
	                
	            },
	            error: function(e) {
	                window.doing = false;
	                console.log('服务端出错');
	            }
	        });
		});
		
		function isPhoneNumber(phoneNum){
			var partten = /^1[3,5,8]\d{9}$/;
			if(partten.test(phoneNum)){
				return true;
			}else{
				return false;
			}
		}
		
	</script>
	    <script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
	    <script type="text/javascript" src="js/wxShare.js"></script>
</html>
