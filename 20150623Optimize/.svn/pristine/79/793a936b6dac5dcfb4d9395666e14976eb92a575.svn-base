<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta name="format-detection" content="telephone=no" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="renderer" content="webkit" />
<meta http-equiv="pragma" content="no-cache" />
<meta http-equiv="Cache-Control" content="no-cache, must-revalidate" />
<meta http-equiv="expires" content="Wed, 26 Feb 1997 08:21:57 GMT" />
<title>活动统计</title>
<link href="style.css" rel="stylesheet" />
<script src="../../tron/coms/jquery/jquery-2.1.1/jquery-2.1.1.min.js"></script>
<script src="../../tron/coms/jquery-plugins/jquery.cookie/jquery.cookie.js"></script>
<script src="../../series/plugins/mustache/mustache.min.js"></script>
<script src="../../series/date.js"></script>
</head>
<body>
<div class="wrap activeCount" id="actwrap"></div>
<script type="text/Mustache" id="list">
<ul>
{{#list}}
	<li class="title" id="title{{order}}" data-type="{{activityType}}" data-id="{{activityId}}">{{activityName}}({{type}})<span class="status status0">{{activityStatus}}</span></li>
	<li class="content" id="content{{order}}"></li>
{{/list}}
</ul>
</script>
<script type="text/Mustache" id="detail">
<p>活动日期：<span class="colorBlue">{{StartDate}}-{{EndDate}}</span></p>
<p>活动名称：<span class="colorBlue">{{CouponName}}</span></p>
<p>活动内容：<span class="colorBlue">{{CouponContent}}</span></p>
<p class="m10">预计发放共计：<span class="colorBlue">{{SheetNumber}}张</span></p>
<p>已发放：<span class="colorBlue">{{SendCount}}张</span></p>
<p>已使用：<span class="colorBlue">{{usedCount}}张</span></p>
<p>尚未使用：<span class="colorBlue">{{unusedCount}}张</span></p>
<p>带动消费金额：<span class="colorBlue">￥{{consumeAmount}}</span></p>
{{{reason}}}
{{{tips}}}
</script>
<script type="text/javascript">
	//Mustache
	var qs = {}, page = 1, doing = false, ismore = true, o = 0;
  $(document).ready(function(){
		var s = window.location.search ? window.location.search.substr(1) : (window.location.href.split('?') > 1 ? window.location.href.split('?')[1] : '');
				s = s.split('&');
				for ( var i = 0 ; i < s.length ; i++ ){
					var d = s[i].split('=');
					qs[d[0]] = d[1];
					$("[name='" + d[0] + "']").val(d[1]);
				}
		
		getData(resize);
  });
	
	function resize(){
		$(window).on('scroll', function(){
			var wh = $(window).height();
			var sh = $('body').scrollTop();
			
			if ( wh + sh + 50 >= $('body').outerHeight() && !doing && ismore ){
				page++;
				getData();
			}
		});
	}
	
	function getData(callback){
		if ( doing ) return;
		var data = {'shopId': qs.s, 'pageSize': 15, 'pageIndex': page};
		doing = true;
		$.post('/Coupon/CouponMsg.aspx?action=query_promotionActivity_list', data, function(data){
			if ( data.error === 0 ){
				ismore = data.msg.isMore;
				var datas = [];

				for ( var i = 0 ; i < data.msg.PromotionActivity.length ; i++ ){
					var msg = data.msg.PromotionActivity[i];
					msg.id = msg.activityId;
					msg.type = postType(msg.activityType);
					msg.order = msg.activityId;
					datas.push(msg)
				}
				
				o = data.msg.PromotionActivity.length;

				$('#actwrap').append(Mustache.render($('#list').html(), { list: datas })); 
				
				//抵扣券为空
				if(data.msg.PromotionActivity.length == 0){
				  $('#actwrap').html('暂无抵扣券活动^_^');
				}
				
				$('ul:last .title').on('click', function(){
					if ( doing ) return;
					var id = $(this).data('id'), top;
					if ( !this.factory ){
						var type = $(this).data('type');
						var mods = new listModals(type, id, this);
						this.factory = mods;
						var id = $(this).attr('id');
						mods.get().use(function(mains){
							if ( mains.error === 0 ){
								this.format(mains.msg);
								this.resolve();
								this.open();
								top = $("#" + id).offset().top;
								$('body').animate({scrollTop: top + 'px'}, 'fast');
							}else{
								this.reject();
							}
						});
					}
					else if ( this.factory && (this.factory.status !== 'resolved') ){
						return;
					}
					else{
						if ( $(this).next().hasClass('active') ){
							closetab();
						}else{
							opentab.call(this);
							top = $("#" + id).offset().top;
							$('body').animate({scrollTop: top + 'px'}, 'fast');
						}
					}
				});
				typeof callback === 'function' && callback();
			}else{
				showMask(data.msg);
			}
			doing = false;
		}, 'json');
	}
	
	function listModals(activityType, activityId, element){
		this.type = activityType;
		this.id = activityId;
		this.status = 'pending';
		this.fn = null;
		this.element = element;
		this.element.factory = this;
	}
	//new Date().format('yyyy年MM月dd日 hh:mm:ss')
	listModals.prototype.get = function(){
		if ( doing ) return;
		var data = { activityType: this.type, activityId: this.id };
		var that = this;
		doing = true;
		$.post('/Coupon/CouponMsg.aspx?action=query_promotionActivity', data, function(data){
			that.fn.call(that, data);
			doing = false;
		}, 'json');
		return this;
	}
	
	listModals.prototype.resolve = function(fn){
		this.status = 'resolved';
		return this;
	}
	
	listModals.prototype.reject = function(fn){
		this.status = 'reject';
		return this;
	}
	
	listModals.prototype.use = function(fn){
		this.fn = fn;
		return this;
	}
	
	listModals.prototype.format = function(msg){
		msg.EndDate = new Date(msg.EndDate * 1000).format('yyyy.MM.dd');
		msg.StartDate = new Date(msg.StartDate * 1000).format('yyyy.MM.dd');
		if ( msg.activityStatus === -1 || msg.activityStatus === -2 ){
			msg.tips = msg.activityStatus === -1 ? '<p style="padding-top:10px; color:red;">我们的运营会尽快给您审核的，请您耐心等待哟~</p>' : '<p style="color:red;">请您不要灰心，请尽快联系我们的服务经理或者重新填写申请单，谢谢!</p>';
		}
		
		if ( msg.activityStatus === -2 ){
			msg.reason = '<p style="padding-top:10px; color:red;"><strong>未通过的理由：</strong></p><p style="color:red;">' + msg.RefuseReason + '</p>';
		}
		
		$(this.element).next().html(Mustache.render($('#detail').html(), msg)); 
	}
	
	listModals.prototype.open = function(){
		opentab.call(this.element);
	}
	
	function postType(d){
		if ( d === 1 ){
			return '抵扣券';
		}
		else if ( d === 2 ){
			return '短信';
		}
		else if ( d === 3 ){
			return 'app推送';
		}
	}
	
	function opentab(){
		var id = $(this).attr('id'); 
		var num = id.substr(5,id.length);	
		$('.activeCount .content').removeClass('active');
		$('#content'+num).addClass('active');	
	}
	
	function closetab(){
		$('.activeCount .content').removeClass('active');
	}
</script>
</body>
</html>