<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <meta name="format-detection" content="telephone=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="renderer" content="webkit" />
    <meta http-equiv="pragma" content="no-cache" />
    <meta http-equiv="Cache-Control" content="no-cache, must-revalidate" />
    <meta http-equiv="expires" content="Wed, 26 Feb 1997 08:21:57 GMT" />
    <title>会员浏览</title>
    <link href="style.css" rel="stylesheet" />
    <link href="../../tron/bootstrap/css/font-awesome.min.css" rel="stylesheet" />
    <script src="../../tron/coms/jquery/jquery-2.1.1/jquery-2.1.1.min.js"></script>
    <script src="../../tron/coms/jquery-plugins/jquery.cookie/jquery.cookie.js"></script>
    <script src="../../series/plugins/mustache/mustache.min.js"></script>
    <script src="all.js"></script>
  </head>
  <body>
    <div class="wrap vipView" id="actwrap" style="position: relative;"></div>
    <script type="text/Mustache" id="list">
    <div class="shopInfo" id="shopInfo">
      <p class="tool">
        <span class="goCon" id="refresh" data-type="refresh" data-value="vipView.html?s={{shopId}}&e={{employeeId}}">刷新</span>
        <span id="help" data-type="help" data-value="levelHelp.html">帮助</span>
      </p>
      <div class="c"></div>
      <p class="title">{{shopName}}</p>
      <p>当前商户级别：<label class="level">{{{lv}}}</label></p>
      <p>已完成订单量：<label id="orderNum">{{prepayOrderCount}}</label>单</p>
      <p>当前积分：<span>{{shopScore}}</span>离升级还需：<span>{{upgradeScore}}</span></p>
    </div>
    <div id="shopInfoClone" style="background: #f1f9ff;"></div>
    <div class="vipInfo">
      <ul class="vipCount">
        <li>
          <div>本月新增会员</div>
          <!--<div id="newVip">{{customerAddedCount}}</div>-->
          <div id="newVip">0</div>
        </li>
        <li>
          <div>累计会员</div>
          <!--<div id="allVip">{{customerCount}}</div>-->
          <div id="allVip">0</div>
        </li>
      </ul>
      <div class="c"></div>
      <div class="percentWrap">
        <div class="percentLight"></div>
        <ul class="percent">
          <li id="percent0"></li>
          <li id="percent1"></li>
          <li id="percent2"></li>
        </ul>
      </div>
      <p id="instr">当前好评(<span class="colorRed" id="a1"></span>)：<span class="colorBlue" id="a2"></span>、中评(<span class="colorRed" id="b1"></span>)：<span class="colorBlue" id="b2"></span>、差评(<span class="colorRed" id="c1"></span>):<span class="colorBlue" id="c2"></span></p>
      <!--，和上周相比，好评上升<span class="colorRed">30%</span>，中评下降<span class="colorBlue">3%</span>，差评上升<span class="colorBlue">0.5%</span>-->
      
    </div>
    
    <div class="activityNews" id="activityNews">
      <ul>
        {{#activityList}}
        <li>{{.}}</li>
        {{/activityList}}
      </ul>
    </div>
    
    <div class="nowActivity" id="nowActivity">
      {{#currentCoupon}}
      <p>当前活动：满<span class="colorRed">{{requirementMoney}}</span>减<span class="colorRed">{{deductibleAmount}}</span>，已发放<span class="colorBlue">{{sendCount}}</span>张（昨日发放<span class="colorBlue">{{yesterdaySendCount}}</span>张），带动消费：<span class="colorRed">{{totalAmount}}</span>元（昨日带动消费<span class="colorRed">{{yesterdayAmount}}</span>元）</p>
      {{/currentCoupon}}
      <ul>
        <li class="btn goCon" id="btnCount" data-type="tj" data-value="activeCount.html?s={{shopId}}">统计</li>
        <li class="btn goCon" id="btnRelase" data-type="post" data-value="release.html?s={{shopId}}&e={{employeeId}}">发布抵扣券</li>
      </ul>
      <div class="c"></div>
    </div>
    
    <div class="comment">
      <ul id="comment">
        <li class="title" id="goodEvaluation">最新好评</li>
        {{#goodEvaluationList}}
        <li class="goCon" data-type="discomment" data-value="{{preOrder19dianId}}" data-values="{{orderId}}">{{evaluationContent}}</li>
        {{/goodEvaluationList}}
        <li class="title" id="middleEvaluation">最新中评</li>
        {{#middleEvaluationList}}
        <li class="goCon" data-type="discomment" data-value="{{preOrder19dianId}}" data-values="{{orderId}}">{{evaluationContent}}</li>
        {{/middleEvaluationList}}
        <li class="title" id="badEvaluation">最新差评</li>
        {{#badEvaluationList}}
        <li class="goCon" data-type="discomment" data-value="{{preOrder19dianId}}" data-values="{{orderId}}">{{evaluationContent}}</li>
        {{/badEvaluationList}}
      </ul>
      <div class="btn goCon" id="showMore" data-type="detail" data-value="userEvaluation.html?s={{shopId}}">查看详细评论</div>
    </div>
    </script>
  </body>
</html>

<script type="text/javascript">
  var qs = {};
  var s = window.location.search ? window.location.search.substr(1) : (window.location.href.split('?') > 1 ? window.location.href.split('?')[1] : '');
  s = s.split('&');
  for ( var i = 0 ; i < s.length ; i++ ){
    var d = s[i].split('=');
    qs[d[0]] = d[1];
    $("[name='" + d[0] + "']").val(d[1]);
  }
  
  var device = getDevices();
  
  var inWx = navigator.userAgent.match(/MicroMessenger/i); // wei xin
  var inAp = device.iOS; // ios
  var inAn = device.Android
  
  $(document).ready(function(){
    var data = {'shopId': qs.s, 'employeeId': qs.e}
    $.post('/Apppages/Shop/ShopHandler.ashx?action=query_shop_detail', data, function(d){
      
      d.msg.shopId = qs.s;
      d.msg.employeeId = qs.e;
      
      var l = {};
      
      for( var i = 0; i < d.msg.evaluationPercent.length; i++){
        if( d.msg.evaluationPercent[i].evaluationValue == -1 ){
          d.msg.evaluationPercent[i].evaluationValue = 2;
        }
        l[d.msg.evaluationPercent[i].evaluationValue] = d.msg.evaluationPercent[i];
        
      }
      d.msg.lv = level(d.msg.shopLevel);
      var h = '';
      for( var i = 0; i < d.msg.lv[1]; i++){
        h += '<img src="http://image220.u-xian.com/UploadFiles/Images/15/grade/level-'+d.msg.lv[0]+'.png"/>';
      }
      d.msg.lv = h;
      
      $('#actwrap').html(Mustache.render($('#list').html(), d.msg));
      
      //最新活动、最热活动为空的情况
      if(d.msg.activityList .length == 0){
        var txt = '<li>最新活动：无</li>';
        txt += '<li>最牛活动：无</li>';
        txt += '<li>最热活动：无</li>';
        txt += '<li>最有效活动：无</li>';
        $('#activityNews').html(txt);
      }
      
      //如果当前活动ID为0，即满0减0的情况
      if(d.msg.currentCoupon.currentCouponId == 0){
        $('#nowActivity p').html('当前活动：无')
      }
      
      //是否显示统计按钮
      if(!d.msg.staticsRight){
        $('#btnCount').css({"display":"none"});
      }
      //是否显示发布抵扣券按钮
      if(!d.msg.sendCouponRight){
        $('#btnRelase').css({"display":"none"});
      }
      
      //无好评
      if ( d.msg.goodEvaluationList.length == 0){
        $('#goodEvaluation').after('<li>无记录</li>');
      }
      //无中评
      if ( d.msg.middleEvaluationList.length == 0){
        $('#middleEvaluation').after('<li>无记录</li>');
      }
      //无差评
      if ( d.msg.badEvaluationList.length == 0){
        $('#badEvaluation').after('<li>无记录</li>');
      }
      //好中差均无评论
      if( d.msg.goodEvaluationList.length == 0 &&  d.msg.middleEvaluationList.length == 0 && d.msg.badEvaluationList.length == 0 ){
        $('#showMore').css({'display':'none'});
      }
      
      abc = d.msg.evaluationPercent;
      
      var a0 = parseFloat(((abc[0].percent)*100).toFixed(1));
      var a1 = parseFloat(((abc[1].percent)*100).toFixed(1));
      var a2 = parseFloat(((abc[2].percent)*100).toFixed(1));
      var aSum = a0+a1+a2;
      var bad = 0;
      var middle = 0;
      var b = aSum - 100;
      for( var i = 0; i < abc.length; i++ ){
        if(abc[i].evaluationValue == 2){  //差评
          $('#c1').html(abc[i].count);
          $('#c2').html( ((abc[i].percent)*100).toFixed(2) +'%' );
          $('#percent2').animate({"width":((abc[i].percent)*100).toFixed(1) +'%'});
          if(abc[i].percent == 1){
            $('#percent2').css({"border-radius":"5px"});
          }
        }else if(abc[i].evaluationValue == 0){
          $('#b1').html(abc[i].count);
          $('#b2').html( ((abc[i].percent)*100).toFixed(2) +'%' );
          $('#percent1').animate({"width": ((abc[i].percent)*100).toFixed(1) +'%'});
          if(abc[i].percent == 1){
            $('#percent1').css({"border-radius":"5px"});
          }
        }else if(abc[i].evaluationValue == 1){
          $('#a1').html(abc[i].count);
          $('#a2').html( ((abc[i].percent)*100).toFixed(2) +'%' );
          if(b>0){
            var dd = parseFloat(((abc[i].percent)*100).toFixed(1))-b;
            $('#percent0').animate({"width": dd +'%'});
          }else{
            $('#percent0').animate({"width":((abc[i].percent)*100).toFixed(1) +'%'});
          }
          if(abc[i].percent == 1){
            $('#percent0').css({"border-radius":"5px"});
          }
        }
      }
      if(aSum == 0){
        $('.percentWrap').css({"display":"none"});
      }
      
      if( inAp ){
        $('.vipView .shopInfo').css({'padding-top':'25px'});
      }else if( inAn ){
        $('.vipView .shopInfo').css({'padding-top':'5px'});
      }
      
      $('.goCon').on('click', function(){
        var type = $(this).attr('data-type'),
        value = $(this).attr('data-value'),
        values = $(this).attr('data-values');
        // 暂时不做
        if ( inAp ){
          window.location = "message:type:"+type+",value:"+value+",value1:"+values;
        }
        else if ( inAn ){
          window.redEnvelopeShare.getRecomandTopicsValue('{ "type": "' + type + '", "value": "' + value + '", "value1": "' + values + '" }');
        }
      });
      
      var h = $('#shopInfo').outerHeight();
      $('#shopInfoClone').css({"height" : h + "px"});
      
      bindScroll(h);
      
      //刷新按钮
      $('#refresh').on('touchstart', function(){
        $('#refresh').css("text-decoration","underline");
      }).on('touchend', function(){
        var type = $(this).attr('data-type'),
        value = $(this).attr('data-value');
        
        if ( inAp ){
          window.location = "message:type:"+type+",value:"+value;
        }
        else if ( inAn ){
          window.redEnvelopeShare.getRecomandTopicsValue('{ "type": "' + type + '", "value": "' + value + '" }');
        }
        $('#refresh').css("text-decoration","none");
      });
      
      //帮助按钮
      $('#help').on('touchstart', function(){
        $('#help').css("text-decoration","underline");
      }).on('touchend', function(){
        var type = $(this).attr('data-type'),
        value = $(this).attr('data-value');
        
        if ( inAp ){
          window.location = "message:type:"+type+",value:"+value;
        }
        else if ( inAn ){
          window.redEnvelopeShare.getRecomandTopicsValue('{ "type": "' + type + '", "value": "' + value + '" }');
        }
        $('#help').css("text-decoration","none");
      })
      
      chking(d.msg.customerAddedCount, 100, 1, 'newVip');
      chking(d.msg.customerCount, 100, 1, "allVip");
      
    }, 'json');
    
    
  });
  
  function bindScroll(h){
    var t = $(document).scrollTop();
    $(window).scroll(function() {
        var t1 = $(document).scrollTop();
        if( t1 > h ){
          if (t1 > h){
            $('#shopInfo').css({"top":"-"+h+"px"});
          }else{
            $('#shopInfo').css({"top":"0"});
          }
  
          if (t1 > t){
            $('#shopInfo').css({"top":"-"+h+"px", "z-index":"2147483647"});
          }else{
            $('#shopInfo').css({"top":"0", "z-index":"2147483647"});
          }
        }else{
            $('#shopInfo').css({"top":"0"});
        }

        t = $(document).scrollTop();  
     });
  }
  
  function level(lv){
    var icons = ['s', 'd', 'g'], deep = [], indexs = 0, length = 1;
        icons.forEach(function(o, i) { deep.push(Math.pow(6, i + 1)); });
        if (lv > 0) {
            for (var i = 0; i < deep.length; i++) {
                if (Math.floor(lv / deep[i]) < (i === 0 ? 1 : i)) {
                    indexs = i;
                    length = Math.floor(lv / deep[i - 1 < 0 ? 0 : i - 1]);
                    if (length === 0) { length = 1; }
                    break;
                }
            }
        }
        if (lv < 6) { length = lv; }
        
        return [icons[indexs], length];
  }

  
  function getDevices() {
    var u = navigator.userAgent, app = navigator.appVersion;
    
    //IOS部分老版本中的UA被替换为“AppServerUXian”引起无法判断IOS设备的问题，通过判断其不为ANDROID设备的方法暂时判断其为IOS设备
    var isOldIOSVer = false;
    if( u.indexOf('AppServerUXian_ANDROID') > -1 ){ isOldIOSVer = false; }
    else{ isOldIOSVer = true; }
    
    return {
      trident: u.indexOf('Trident') > -1,
      presto: u.indexOf('Presto') > -1,
      webKit: u.indexOf('AppleWebKit') > -1,
      gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1,
      mobile: !!u.match(/AppleWebKit.*Mobile.*/),
      iOS: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/) || isOldIOSVer,
      Android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1,
      iPhone: u.indexOf('iPhone') > -1,
      iPad: u.indexOf('iPad') > -1,
      webApp: u.indexOf('Safari') == -1,
    };
  };
  
  function chking(n, t, s, id){
    //n = 数值   t = 动画持续时间   s = 延迟时间
    var step = n * s / t;
    var a = step.toString().split('.');
    var r = 0;
    var g = n * s <= t;
    if( g ){
      var i = 0;
      step = 1;
      dooing(i+1, n, s, id, step);
    }else{
      if(a.length > 1){
        step = parseInt(a[0]);
        //余数
        r = n - ( a[0] * parseInt(n/a[0]) );
        s = s/n;
        var i = 0;
        dooings(i, n, s, id, step, r);
      }else{
        step = parseInt(n/t);
        var i = 0;
        dooings(i, n, s, id, step, r);
      }
    }
  }
  
  function dooing(i, n, s, id, step, r){
    if( i <= n ){
      document.getElementById(id).innerHTML = i;
      i++;
      setTimeout(function(){ dooing(i, n, s, id) }, s);
    }
  }
  function dooings(i, n, s, id, step, r){
    if( i < n ){
      document.getElementById(id).innerHTML = i;
      i = i + step;
      setTimeout(function(){ dooings(i, n, s, id, step, r) }, s);
    }else{
      document.getElementById(id).innerHTML = n
    }
  }
  
</script>


